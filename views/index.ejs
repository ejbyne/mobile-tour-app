<!DOCTYPE html>
<html>
<head>
  <title>Simple Map</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <style>
  html, body, #map-canvas {
    height: 100%;
    margin: 0px;
    padding: 0px
  }
  </style>
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>
  <script>
  // function getLocation() {
  //   if (navigator.geolocation) {
  //       // navigator.geolocation.watchPosition(showPosition);
  //       console.log(navigator.geolocation.getCurrentPosition());
  //   } else { 
  //       // x.innerHTML = "Geolocation is not supported by this browser.";
  //   }
  // }

  var options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
  };

  function success(pos) {
    var crd = pos.coords;

    console.log('Your current position is:');
    console.log('Latitude : ' + crd.latitude);
    console.log('Longitude: ' + crd.longitude);
    console.log('More or less ' + crd.accuracy + ' meters.');
  };

  function error(err) {
    alert('Error(' + err.code + '): ' + err.message);
  };

  function initialize(position) {

    var latitude = position.coords.latitude;
    var longitude = position.coords.longitude;

    var mapOptions = {
      zoom: 17,
      center: new google.maps.LatLng(latitude, longitude)
    };
    var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
    var infoWindow = new google.maps.InfoWindow();
    var service = new google.maps.places.PlacesService(map);

    var image = 'img/glass.svg';

    var currentPositionMarker = new google.maps.Marker({
          position: new google.maps.LatLng(latitude, longitude),
          map: map,
          icon: new google.maps.MarkerImage('img/man.svg', null, null, null, new google.maps.Size(36, 36))
        });
  
    $.get('/mapinfo?latitude=' + latitude + '&longitude=' + longitude, function(data) {
      data.results.forEach(function(place) {
        var marker = new google.maps.Marker({
          position: new google.maps.LatLng(place.geometry.location.lat, place.geometry.location.lng),
          map: map,
          icon: new google.maps.MarkerImage(image, null, null, null, new google.maps.Size(24,24))
        });

        google.maps.event.addListener(marker, 'click', function() {
          service.getDetails(place, function(result, status) {
            if (status != google.maps.places.PlacesServiceStatus.OK) {
              alert(status);
              return;
            }
           
            var address = result.vicinity + ' ' +
                          result.address_components[result.address_components.length-1].long_name + '<br>';

            var website = function() {
              if (result.website) {
                var text = '<a href="' + result.website + '">' + result.website + '</a>';
                return text;
              }
              else {
                return '';
              }
            };

            var openingHours = function() {
              if ( result.opening_hours) {
                var text = '<br>Opening Hours:<br>'
                result.opening_hours.weekday_text.forEach(function(day) {
                  text += day + '<br>'
                });
                return text;
              }
              else {
                return '';
              }
            };

            var details = result.name + '<br>' +
                          address +
                          website() +
                          openingHours();
            infoWindow.setContent(details);
            infoWindow.open(map, marker);
          });
        });
      });
    });
  }

  navigator.geolocation.getCurrentPosition(initialize, error, options);

  // google.maps.event.addDomListener(window, 'load', initialize);

  </script>
</head>
<body>
  <div id="map-canvas"></div>
</body>
</html>
